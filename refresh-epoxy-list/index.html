<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>ä»æºç çœ‹å¦‚ä½•åˆ·æ–° Epoxy åˆ—è¡¨ | Rakuyo&#39;s blog</title>

<link rel="shortcut icon" href="https://blog.rakuyo.dev/favicon.ico?v=1769154921003">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://blog.rakuyo.dev/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
        <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.1/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script> 
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            Rakuyo&#39;s blog
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/reference" class="menu gt-a-link">
                    æ”¶è—
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/friends" class="menu gt-a-link">
                    å‹é“¾
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1769154921003"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    ä»æºç çœ‹å¦‚ä½•åˆ·æ–° Epoxy åˆ—è¡¨
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2024-08-05 Â·
                    </time>
                    
                        <a href="https://blog.rakuyo.dev/tag/epoxy/" class="post-tags">
                            # epoxy
                        </a>
                    
                        <a href="https://blog.rakuyo.dev/tag/FeXshwVXj/" class="post-tags">
                            # ios
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>å¦‚ä½•æ­£ç¡®çš„åˆ·æ–° <a href="https://github.com/airbnb/epoxy-ios">Epoxy</a> åˆ—è¡¨å¯ä»¥è¯´æ˜¯ç†Ÿç»ƒä½¿ç”¨è¿™ä¸ªæ¡†æ¶çš„å…³é”®ï¼Œåˆä¸Šæ‰‹æ—¶æ€»ä¼šæœ‰ â€œä¸ºä»€ä¹ˆåˆ—è¡¨åˆ·æ–°åæ•°æ®æ²¡å˜â€ å’Œ â€œä¸ºä»€ä¹ˆå®ƒåˆ·æ–°åæ•°æ®å°±å˜äº†â€ çš„ç–‘æƒ‘ã€‚</p>
<p>æœ¬æ–‡ä»æºç åˆ†æçš„è§’åº¦ï¼Œå¸¦å¤§å®¶æ¥æ¢³ç† Epoxy åˆ—è¡¨åˆ·æ–°çš„åŸç†ï¼Œå¹¶å­¦ä¼šå¦‚ä½•æ­£ç¡®åˆ·æ–° Epoxy åˆ—è¡¨ã€‚</p>
<!-- more -->
<p>Epoxy åˆ—è¡¨æœ¬è´¨ä¸Šè¿˜æ˜¯ <code>UICollectionView</code>ï¼Œåªä¸è¿‡å®ç°äº† diff ç®—æ³•ï¼Œå°è£…äº† reuse id çš„åˆ›å»ºã€‚</p>
<p>å¯¹äºä¸€ä¸ªå¸¸è§çš„ <code>UICollectionViewCell</code> æˆ– <code>UITableViewCell</code>ï¼Œæˆ‘çš„ä¹ æƒ¯æ˜¯ï¼š</p>
<ul>
<li>Cell åˆå§‹åŒ–æ—¶åˆ›å»º <code>subviews</code>ï¼Œæ·»åŠ åˆ° <code>contentView</code> ä¸Šï¼Œå¹¶è®¾ç½®å¸ƒå±€ã€‚</li>
<li>å¯¹å¤–æš´éœ² <code>config()</code> æ–¹æ³•ï¼Œæˆ–ç›´æ¥æš´éœ² <code>subviews</code>
<ul>
<li>åœ¨ <code>collectionView(_: cellForItemAt:)</code> æ–¹æ³•ä¸­å°†æ•°æ®è®¾ç½®åˆ° <code>subviews</code> ä¸Šã€‚</li>
</ul>
</li>
</ul>
<p>å¦‚æœæƒ³è¦åˆ—è¡¨ä¸Š Cell ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæ— å¤–ä¹ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p>
<ul>
<li>åˆ›å»ºä¸åŒçš„ Cellã€‚ä¸åŒçš„æ•°æ®å¯¹åº”ä¸åŒçš„ Cellï¼ŒæŠ›å¼ƒæˆ–éƒ¨åˆ†æŠ›å¼ƒé‡ç”¨æœºåˆ¶ã€‚</li>
<li>åœ¨ Cell åˆ›å»ºæˆ–å¤ç”¨åï¼Œé‡æ–°è®¾ç½® <code>subviews</code> ä¸Šçš„æ•°æ®ã€‚è¿™åŒ…æ‹¬ä¸¤ç§æ–¹æ³•ï¼š
<ul>
<li><code>collectionView(_: cellForItemAt:)</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>config()</code>ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ <code>subviews</code>ã€‚</li>
<li>ä½¿ç”¨å“åº”å¼æ¡†æ¶ï¼Œæ¯”å¦‚ <code>Combine</code>ï¼Œå°†æ•°æ®ç»‘å®šåˆ° Cell çš„ <code>subviews</code> ä¸Šã€‚</li>
</ul>
</li>
</ul>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»è¿™å‡ ç§æ–¹æ³•ä¸Šå…¥æ‰‹ï¼Œçœ‹çœ‹å¦‚ä½•æ­£ç¡®åˆ·æ–° Epoxy åˆ—è¡¨ã€‚</p>
<h2 id="cell-åˆ›å»ºæµç¨‹">Cell åˆ›å»ºæµç¨‹</h2>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ Epoxy æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ª Cellã€‚åœ¨ä½¿ç”¨æ¡†æ¶æ—¶ï¼Œæˆ‘ä»¬æ²¡æœ‰æ˜¾å¼åˆ›å»ºè¿‡ reuse idï¼ŒEpoxy æ¡†æ¶æ˜¯å¦‚ä½•åˆ›å»ºå®ƒçš„ï¼Ÿ</p>
<h3 id="æºç åˆ†æ">æºç åˆ†æ</h3>
<p>åœ¨ <code>CollectionView/Internal/CollectionViewDataSource.swift</code> ä¸­ï¼Œå…³äº Cell çš„åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-swift">  func collectionView(
    _ collectionView: UICollectionView,
    cellForItemAt indexPath: IndexPath)
    -&gt; UICollectionViewCell
  {
    guard
      let item = data?.item(at: indexPath),
      let section = data?.section(at: indexPath.section),
      let reuseID = reuseIDStore.registeredReuseID(for: item.viewDifferentiator)
    else {
      // The `item(â€¦)` or `registeredReuseID(â€¦)` methods will assert in this scenario.
      return UICollectionViewCell()
    }

    let cell = collectionView.dequeueReusableCell(withReuseIdentifier: reuseID, for: indexPath)

    if let cell = cell as? CollectionViewCell {
      self.collectionView?.configure(
        cell: cell,
        with: item,
        at: .init(itemDataID: item.dataID, section: .dataID(section.dataID)),
        animated: false)
    } else {
      EpoxyLogger.shared.assertionFailure(
        &quot;Only CollectionViewCell and subclasses are allowed in a CollectionView.&quot;)
    }
    return cell
  }
</code></pre>
<p>é¦–å…ˆå…³æ³¨åˆ›å»º Cell æ—¶ä½¿ç”¨çš„æ ‡è¯†ç¬¦ï¼Œå³ <code>reuseID</code> è¿™ä¸ªå˜é‡æ˜¯ä»ä½•è€Œæ¥çš„ã€‚</p>
<pre><code class="language-swift">let reuseID = reuseIDStore.registeredReuseID(for: item.viewDifferentiator)
</code></pre>
<p>è¿™é‡ŒåŒ…å«ä¸¤ä¸ªéœ€è¦æ˜ç™½çš„å†…å®¹ï¼Œåˆ†åˆ«æ˜¯ <code>reuseIDStore</code> å’Œ <code>viewDifferentiator</code>ã€‚</p>
<p>ä»åå¾€å‰çœ‹ï¼Œ<code>viewDifferentiator</code> å®šä¹‰åœ¨ <code>ViewDifferentiatorProviding</code> åè®®é‡Œï¼Œå®ƒçš„ç±»å‹ <code>ViewDifferentiator</code> æ˜¯ä¸€ä¸ªéµå¾ª <code>Hashable</code> çš„ç»“æ„ä½“ï¼š</p>
<pre><code class="language-swift">// MARK: - ViewDifferentiatorProviding

public protocol ViewDifferentiatorProviding {
  var viewDifferentiator: ViewDifferentiator { get }
}

// MARK: - ViewDifferentiator

public struct ViewDifferentiator: Hashable {
  public init(viewType: AnyClass, styleID: AnyHashable?) {
    viewTypeDescription = &quot;\(type(of: viewType.self))&quot;
    self.styleID = styleID
  }

  public var viewTypeDescription: String
  public var styleID: AnyHashable?
}
</code></pre>
<p>ä»æºç æ³¨é‡Šä¸Šå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸¤ä¸ªç±»å‹å°±æ˜¯æœåŠ¡äº reuseID åˆ›å»ºçš„ã€‚<code>ItemModel</code> æ˜¯è¿™ä¹ˆå®ç° <code>ViewDifferentiatorProviding</code> åè®®çš„ï¼š</p>
<pre><code class="language-swift">extension ItemModel {
  public var viewDifferentiator: ViewDifferentiator {
    .init(viewType: View.self, styleID: styleID)
  }
  ...
}
</code></pre>
<p>è¿™é‡Œçš„ View æ˜¯ä¸€ä¸ªèŒƒå‹ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®ç°äº† <code>EpoxyableView</code> çš„ UIView å¯¹è±¡ã€‚<code>styleID</code> å®šä¹‰åœ¨ <code>StyleIDProviding</code> åè®®ä¸­ï¼Œæ˜¯ä¸€ä¸ªæ‰©å±•å‡ºæ¥çš„å­˜å‚¨å±æ€§ï¼Œå…¶ç±»å‹æ˜¯ <code>AnyHashable</code>ï¼Œè¿™é‡Œå°±çœç•¥å±•ç¤ºå®ƒçš„å®šä¹‰äº†ã€‚</p>
<p>é‚£ä¹ˆä½¿ç”¨æ—¶å®ƒçš„å€¼æ˜¯å“ªå„¿æ¥çš„å‘¢ï¼Ÿ</p>
<pre><code class="language-swift">public struct ItemModel&lt;View: UIView&gt;: ViewEpoxyModeled {
  ...
  
  public init&lt;Params: Hashable, Content: Equatable&gt;(
    dataID: AnyHashable,
    params: Params,
    content: Content,
    makeView: @escaping (Params) -&gt; View,
    setContent: @escaping (CallbackContext, Content) -&gt; Void)
  {
    self.dataID = dataID
    styleID = params // â¬…ï¸ åœ¨è¿™é‡Œè¿›è¡Œèµ‹å€¼
    erasedContent = content
    self.makeView = { makeView(params) }
    self.setContent = { setContent($0, content) }
    isErasedContentEqual = { otherModel in
      guard let otherContent = otherModel.erasedContent as? Content else { return false }
      return otherContent == content
    }
  }
  
  ...
}
</code></pre>
<p>ä¸Šé¢è¿™ä¸ªæ˜¯ <code>ItemModel</code> çš„åˆå§‹ã€åŸºæœ¬åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨åˆå§‹åŒ–æ—¶ï¼Œæ˜¯ä½¿ç”¨ <code>params</code> è¿™ä¸ªå‚æ•°åˆå§‹åŒ– <code>styleID</code> å±æ€§çš„ã€‚ä½†æ˜¯åŸºæœ¬ä¸Šæˆ‘ä»¬éƒ½å¾ˆå°‘ä½¿ç”¨è¿™ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸‹é¢è¿™ä¸ªï¼š</p>
<pre><code class="language-swift">extension StyledView where Self: BehaviorsConfigurableView &amp; ContentConfigurableView {
  public static func itemModel(
    dataID: AnyHashable,
    content: Content,
    behaviors: Behaviors? = nil,
    style: Style)
    -&gt; ItemModel&lt;Self&gt;
  {
    ItemModel&lt;Self&gt;(
      dataID: dataID,
      params: style, // â¬…ï¸ å‘ç° params çš„æ¥æº
      content: content,
      makeView: Self.init(style:),
      setContent: { context, content in
        context.view.setContent(content, animated: context.animated)
      })
      .setBehaviors { context in
        context.view.setBehaviors(behaviors)
      }
  }
}
</code></pre>
<p>çœ‹åˆ°è¿™é‡Œå°±æ˜ç™½äº†ï¼šè¿™ä¸ª <code>styleID</code> å°±æ˜¯åˆ›å»º <code>EpoxyableView</code> æ—¶å®šä¹‰çš„ <code>Style</code>ã€‚æ‰€ä»¥ <code>viewDifferentiator</code> ä»£è¡¨çš„å°±æ˜¯éµå¾ª <code>EpoxyableView</code> åè®®çš„è¿™ä¸ªç±»å‹æœ¬èº«ä»¥åŠå®ƒæ‰€åŒ…å«çš„ <code>Style</code> å¯¹è±¡ã€‚<strong>å½“åŒä¸€ä¸ª View ä½†æ˜¯ Style ä¸åŒæ—¶ï¼Œ<code>viewDifferentiator</code> ä¹Ÿå°±ä¸åŒã€‚</strong></p>
<p>çœ‹å®Œäº† <code>viewDifferentiator</code>ï¼Œè®©æˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹ <code>reuseIDStore</code>ã€‚</p>
<p>å®ƒçš„ç±»å‹æ˜¯ä¸€ä¸ªç±» <code>ReuseIDStore</code>ï¼Œä»å‘½åä¸Šå¯ä»¥çœ‹å‡ºè¿™ä¸ªç±»æ˜¯ä¸“é—¨ç”¨æ¥å­˜å‚¨ reuse id çš„ã€‚é€šè¿‡<a href="">æºç </a>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»å†…éƒ¨ä½¿ç”¨ä¸¤ä¸ª Dictionary æ¥å°è£… reuse id çš„åˆ›å»ºã€å­˜å‚¨ä»¥åŠè¯»å–é€»è¾‘ã€‚</p>
<p>å¯¹å¤–ä¸»è¦æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>reuseID(byRegistering:)</code> å’Œ <code>registeredReuseID(for:)</code>ï¼Œå‚æ•°éƒ½æ˜¯ <code>ViewDifferentiator</code>ã€‚å‰è€…ç”¨äºå­˜å‚¨ reuse idï¼Œåè€…è´Ÿè´£æŸ¥è¯¢è¯»å–ã€‚</p>
<p>å†…éƒ¨åŒ…å«ä»¥ä¸‹ä¸¤ä¸ª Dictionary:</p>
<pre><code class="language-swift">private var uniqueViewDifferentiatorCountsForViewTypes = [String: Int]()
private var reuseIDsForViewDifferentiators = [ViewDifferentiator: String]()
</code></pre>
<p><code>uniqueViewDifferentiatorCountsForViewTypes</code> è´Ÿè´£è®¡æ•°ï¼Œå³ä¸€ä¸ª CollectionView æ³¨å†Œäº†å‡ æ¬¡è¿™ä¸ª Viewï¼ˆCellï¼‰ã€‚</p>
<p>é€šè¿‡è¿½è¸ªè°ƒç”¨æ ˆï¼Œå¯ä»¥å‘ç°æ¯æ¬¡è°ƒç”¨ <code>setSections(_: strategy:)</code> æ–¹æ³•æ—¶ï¼Œå¦‚æœå­˜åœ¨æ–°çš„ <code>ViewDifferentiator</code>ï¼Œå°±ä¼šè°ƒç”¨ <code>reuseID(byRegistering:)</code> è¿›è¡Œæ³¨å†Œã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ç»“åˆæ³¨å†Œæ–¹æ³• <code>reuseID(byRegistering:)</code> çš„å®ç°æ¥ä¸€èµ·çœ‹ï¼š</p>
<pre><code class="language-swift">public func reuseID(byRegistering viewDifferentiator: ViewDifferentiator) -&gt; String {
  if let existingReuseID = reuseIDsForViewDifferentiators[viewDifferentiator] {
    return existingReuseID
  }

  let viewType = viewDifferentiator.viewTypeDescription
  let uniqueViewDifferentiatorCount = uniqueViewDifferentiatorCountsForViewTypes[viewType] ?? 0
  uniqueViewDifferentiatorCountsForViewTypes[viewType] = uniqueViewDifferentiatorCount + 1

  let reuseID = &quot;\(viewType)_\(uniqueViewDifferentiatorCount)&quot; // â¬…ï¸ ç±»å‹åŠ å‡ºç°æ¬¡æ•°
  reuseIDsForViewDifferentiators[viewDifferentiator] = reuseID
  return reuseID
}
</code></pre>
<p><code>ViewDifferentiator</code> æ˜¯éµå¾ª <code>Hashable</code> çš„ï¼Œå¯¹äºåŒä¸€ä¸ª <code>View</code> ç±»å‹è€Œè¨€ï¼Œä¸åŒçš„ <code>Style</code> å®ä¾‹æ„å‘³ç€ä¸åŒçš„ <code>ViewDifferentiator</code>ï¼Œæ¯ä¸€ç§éƒ½ä¼šè°ƒç”¨ <code>reuseID(byRegistering:)</code> è¿›è¡Œæ³¨å†Œã€‚é€šè¿‡ç´¯åŠ  countï¼Œå¯ä»¥ä¿è¯ä¸åŒçš„ <code>ViewDifferentiator</code> å¯¹åº”ä¸åŒçš„ reuse idã€‚</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä¾‹å­æ¥æ€»ç»“ä¸€ä¸‹ reuse id çš„åˆ›å»ºè¿‡ç¨‹å’Œåˆ›å»ºç»“æœã€‚</p>
<p>å‡è®¾å®šä¹‰å¦‚ä¸‹ä¸€ä¸ª Viewï¼š</p>
<pre><code class="language-swift">final class TextRow: UIView, EpoxyableView {
  enum Style {
    case small, large
  }
}
</code></pre>
<p>ä½¿ç”¨æ—¶å¦‚ä¸‹ï¼š</p>
<pre><code class="language-swift">// ... other row

TextRow.itemModel(dataID: &quot;small&quot;, style: .small)

// ... other row

TextRow.itemModel(dataID: &quot;large&quot;, style: .large)

// ... other row
</code></pre>
<p>é‚£ä¹ˆå½“æˆ‘ä»¬è°ƒç”¨ <code>collectionView.setSections(_: strategy:)</code> æ—¶ï¼Œå› ä¸ºä¸¤ä¸ª <code>ItemModel</code> å®ä¾‹å¯¹åº”çš„ Style ä¸åŒï¼Œ<code>CollectionView</code> ä¸­å°±ä¼šæ³¨å†Œä¸¤ä¸ª Cellï¼Œreuse id åˆ†åˆ«ä¸º <code>TextRow_0</code> å’Œ <code>TextRow_1</code>ã€‚</p>
<p>æ‰€ä»¥å¦‚æœä½ å¸Œæœ›æŠ›å¼ƒæˆ–éƒ¨åˆ†æŠ›å¼ƒ Cell çš„é‡ç”¨æœºåˆ¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦ä¿è¯ reuse id å„ä¸ç›¸åŒï¼Œå³ <strong>ä½¿ç”¨ä¸åŒçš„ Viewï¼Œæˆ–è€…ä¸åŒçš„ View.Style</strong>ã€‚</p>
<p>åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬å¸¸é€šè¿‡å­—é¢å«ä¹‰ï¼Œå°†æ¯”å¦‚ TextColor ç­‰ UI æ ·å¼å°è£…åœ¨ Style ä¸­ã€‚åœ¨é‡åˆ° â€œå¯ç”¨æ—¶æ˜¾ç¤ºé»‘è‰²ï¼Œä¸å¯ç”¨æ—¶å±•ç¤ºç°è‰²â€ è¿™ç§éœ€æ±‚æ—¶ï¼ŒåŠ¨æ€ä¿®æ”¹ TextColorï¼Œéšåè°ƒç”¨ <code>setSections(_: strategy:)</code> åˆ·æ–°åˆ—è¡¨ã€‚è¿™æ—¶åˆ—è¡¨æ•°æ®å‘ç”Ÿå˜åŠ¨ï¼Œå…¶å®æ˜¯ reuse id ä¸åŒï¼Œç³»ç»Ÿåˆ›å»ºäº†æ–°çš„ Cell æ¥å±•ç¤ºä¸åŒçš„æ–‡å­—é¢œè‰²ã€‚å¾ˆå¤šæ—¶å€™è¿™ç§ç°è±¡å…¶å®è¿èƒŒäº†å¼€å‘è€…çš„åˆè¡·ã€‚</p>
<h2 id="æ›´æ–°-cell-æ•°æ®">æ›´æ–° Cell æ•°æ®</h2>
<p>å¦å¤–ä¸€ç§æ–¹æ³•å°±æ˜¯æ›´æ–° Cell ä¸Šå­è§†å›¾çš„æ•°æ®ï¼Œæ¯”å¦‚ Label çš„ <code>text</code> ç­‰ã€‚åœ¨ Epoxy ä¸­ï¼Œæˆ‘ä»¬å¸¸å°†æ•°æ®å®šä¹‰åœ¨ Content é‡Œï¼Œå¹¶åœ¨ <code>setContent(_: animated:)</code> æ–¹æ³•å†…å°†æ•°æ®æ¸²æŸ“åˆ° UI ä¸Šï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p>
<pre><code class="language-swift">extension HeaderRow: ContentConfigurableView {
    struct Content: Equatable {
        let title: String
        let tips: String?
    }
    
    func setContent(_ content: Content, animated: Bool) {
        titleLabel.text = content.title
        tipsLabel.text = content.tips
    }
}
</code></pre>
<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯ä¿®æ”¹äº† <code>Content</code> ä¹‹åï¼Œå†è°ƒç”¨ <code>setSections(_: strategy:)</code> åˆ·æ–°åˆ—è¡¨å³å¯åˆ·æ–° UIï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æºç ã€‚</p>
<h3 id="content-è®¾ç½®æµç¨‹">Content è®¾ç½®æµç¨‹</h3>
<br>
<h4 id="æºç åˆ†æ-2">æºç åˆ†æ</h4>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>itemModel(dataID: content: behaviors: style:)</code> æ–¹æ³•çš„å®šä¹‰ï¼Œå®ƒæ˜¯ <code>EpoxyableView</code> åˆ›å»º <code>ItemModel</code> çš„æ–¹æ³•ã€‚</p>
<pre><code class="language-swift">extension StyledView where Self: BehaviorsConfigurableView &amp; ContentConfigurableView {
  public static func itemModel(
    dataID: AnyHashable,
    content: Content,
    behaviors: Behaviors? = nil,
    style: Style)
    -&gt; ItemModel&lt;Self&gt;
  {
    ItemModel&lt;Self&gt;(
      dataID: dataID,
      params: style,
      content: content, // â¬…ï¸ ä¼ å…¥
      makeView: Self.init(style:),
      setContent: { context, content in // â¬…ï¸ åœ¨é—­åŒ…å†…åˆåäº†å‡ºæ¥ï¼Œç›¸å½“äºé—­åŒ…æŒæœ‰äº† Content å®ä¾‹
        context.view.setContent(content, animated: context.animated)
      })
      .setBehaviors { context in
        context.view.setBehaviors(behaviors)
      }
  }
}
</code></pre>
<p>ä»å®ç°ä¸Šçœ‹ï¼Œ<code>content</code> å®ä¾‹è¢«åŒ…è£¹è¿›äº† <code>setContent</code>  é—­åŒ…ï¼Œå»¶è¿Ÿåˆ°åˆé€‚çš„æ—¶æœºå†è¿›è¡Œè°ƒç”¨ï¼š</p>
<pre><code class="language-swift">extension ItemModel: InternalItemModeling {
  ...

  public func configure(cell: ItemWrapperView, with metadata: ItemCellMetadata) {
    // Even if there's no `setContent` closure, we need to make sure to call `viewForCell` to ensure that the cell is set up.
    let view = viewForCell(cell)
    setContent?(.init(view: view, metadata: metadata))
  }

  ...
}
</code></pre>
<blockquote>
<p>è¿™é‡Œæ’ä¸€å¥ï¼Œåœ¨å¯»æ‰¾ <code>setContent</code> é—­åŒ…çš„ Caller æ—¶ï¼Œä½ æœ‰å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-swift">extension AnyItemModel: InternalItemModeling {
  ...
  public func configure(cell: ItemWrapperView, with metadata: ItemCellMetadata) {
    model.configure(cell: cell, with: metadata)
    if let view = cell.view {
      setContent?(.init(view: view, metadata: metadata))
    }
  }
  ...
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•å±äº <code>AnyItemModel</code>ï¼Œè¿™ä¸ªç±»å‹æ“¦é™¤è´Ÿè´£åŒ…è£¹ä¸åŒçš„ <code>ItemModel</code> å®ä¾‹ï¼Œæ–¹æ³•ç¬¬ä¸€è¡Œçš„ <code>model</code> å³æ˜¯å®ƒæ‰€åŒ…è£…çš„ <code>ItemModel</code> å®ä¾‹ã€‚</p>
<p>ä¸ºä»€ä¹ˆæåˆ°è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿå› ä¸ºè¿™ä¸ªæ–¹æ³•çœ‹ä¸Šå»è°ƒç”¨äº†ä¸¤æ¬¡ <code>setContent</code> é—­åŒ…ã€‚ç„¶è€Œå®é™…ä¸Šï¼Œä¸æ­¢ <code>setContent</code>ï¼Œ<code>AnyItemModel</code> ä¸­çš„å…¶ä»–ç±»ä¼¼çš„å±æ€§ï¼ˆæ¯”å¦‚ <code>setBehaviors</code>ï¼‰éƒ½æ˜¯ <code>nil</code>ï¼Œæ‰€ä»¥ <code>setContent</code> é—­åŒ…åªè°ƒç”¨äº†ä¸€æ¬¡ï¼Œé‡ç‚¹è¿˜æ˜¯å…³æ³¨ <code>ItemModel</code> çš„ <code>configure(cell: with:)</code> æ–¹æ³•ã€‚</p>
<p><code>AnyItemModel</code> çš„ <code>setContent</code> æ˜¯ <code>nil</code> æ˜¯è®¾è®¡ä¸Šå†³å®šçš„ï¼Œé¡¹ç›®ä¸­æœç´¢ä¸åˆ°å¯¹å…¶è¿›è¡Œèµ‹å€¼çš„ä»£ç ã€‚è‡³äºä¸ºä»€ä¹ˆæ˜æ˜æ²¡æœ‰èµ‹å€¼ï¼Œå´è¿˜æœ‰è°ƒç”¨ï¼ŒçŒœæµ‹æ˜¯ä¸ºäº†æ¶æ„ä¸Šçš„ç»Ÿä¸€ï¼Ÿ</p>
</blockquote>
<p>ç»§ç»­å‘ä¸Šå¯»æ‰¾è°ƒç”¨æ–¹ï¼Œå¯ä»¥å‘ç°æ˜¯åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ <code>collectionView(_: cellForItemAt:)</code> æ–¹æ³•å†…è°ƒç”¨çš„ã€‚æ–¹æ³•å®ç°å†…æœ‰ä¸€è¡Œ <code>self.collectionView?.configure( ... )</code>ï¼Œè¯¥æ–¹æ³•å†…æ— åˆ¤æ–­åœ°è°ƒç”¨äº† model çš„ <code>configure(cell: with:)</code> æ–¹æ³•ã€‚</p>
<h4 id="å°ç»“-2">å°ç»“</h4>
<p>æ€»ç»“ä¸€ä¸‹é€»è¾‘å’Œè°ƒç”¨é“¾ï¼š</p>
<p>åˆ·æ–° <code>CollectionView</code> æ—¶ï¼Œæ‰§è¡Œ <code>collectionView(_: cellForItemAt:)</code>ï¼Œé€šè¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆ <code>model.setContent</code> é—­åŒ…è¢«è°ƒç”¨ï¼ŒView çš„ <code>setContent(_: animated)</code> è¢«è°ƒç”¨ï¼Œæ–°çš„ <code>Content</code> è¢«è®¾ç½®åˆ° UI ä¸Šã€‚</p>
<p>åˆ°è¿™é‡Œç»“æŸäº†å—ï¼Ÿè¿˜ä¸è¦é«˜å…´çš„å¤ªæ—©ï¼Œä¸è¦å¿˜è®°äº† <code>CollectionView</code> è¿˜å­˜åœ¨ Diff çš„é€»è¾‘ï¼šæ›´æ–° <code>Content</code> å®ä¾‹åè°ƒç”¨ <code>setSections(_: strategy:)</code>ï¼Œ<code>CollectionView</code> ä¸€å®šä¼šè¢«åˆ·æ–°å—ï¼Ÿæœªå¿…ã€‚</p>
<h3 id="collectionview-åˆ·æ–°æ—¶æœº">CollectionView åˆ·æ–°æ—¶æœº</h3>
<br>
<h4 id="æºç åˆ†æ-3">æºç åˆ†æ</h4>
<p>è®©æˆ‘ä»¬è‡ªé¡¶å‘ä¸‹çœ‹ï¼Œå…ˆçœ‹ <code>setSections(_: strategy:)</code> çš„å®ç°ï¼š</p>
<pre><code class="language-swift">open class CollectionView: UICollectionView {
  ...

  public func setSections(_ sections: [SectionModel], animated: Bool) {
    let strategy: UpdateStrategy
    if configuration.usesBatchUpdatesForAllReloads {
      strategy = animated ? .animatedBatchUpdates : .nonanimatedBatchUpdates
    } else {
      strategy = animated ? .animatedBatchUpdates : .reloadData
    }
    setSections(sections, strategy: strategy)
  }

  public func setSections(_ sections: [SectionModel], strategy: UpdateStrategy) {
    EpoxyLogger.shared.assert(Thread.isMainThread, &quot;This method must be called on the main thread.&quot;)
    epoxyDataSource.registerSections(sections)
    apply(.make(sections: sections), strategy: strategy)
  }

  ...
}
</code></pre>
<p><code>registerSections()</code> ä¸Šæ–‡æœ‰æåˆ°ï¼Œè´Ÿè´£æ³¨å†Œ Section ä»¥åŠ Cellã€‚é‡ç‚¹å…³æ³¨ä¸‹é¢çš„ <code>apply(_: strategy:)</code> æ–¹æ³•ã€‚æŸ¥çœ‹è¯¥çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°å…¶å†…éƒ¨è°ƒç”¨äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="language-swift">open class CollectionView: UICollectionView {
  ...

  private func updateView(with data: CollectionViewData, strategy: UpdateStrategy) {
    updateState = .preparingUpdate

    let performUpdates = {
      self.performBatchUpdates({
        self.performUpdates(data: data, animated: strategy.animated)
      }, completion: { _ in
        if let nextUpdate = self.queuedUpdate, self.window != nil {
          self.queuedUpdate = nil
          self.updateView(with: nextUpdate.newData, strategy: nextUpdate.strategy)
        } else {
          self.completeUpdates()
        }
      })
    }

    // There's two cases in which we should always have a strategy of `.reloadData`:
    // - The first update, since we're going from empty content to non-empty content, and we don't want to animate that update.
    // - Before the first layoutÂ of this collection view when `bounds.size` is still zero, since there's no benefit to doing batch updates in that scenario.
    let override = (epoxyDataSource.data == nil || bounds.size == .zero) ? .reloadData : strategy

    switch override {
    case .animatedBatchUpdates:
      performUpdates()
    case .nonanimatedBatchUpdates:
      UIView.performWithoutAnimation {
        performUpdates()
      }
    case .reloadData:
      let result = epoxyDataSource.applyData(data)
      updateState = .updating(from: result.oldData)
      reloadData()
      completeUpdates()
    }
  }

  ...
}
</code></pre>
<p>é€šè¿‡ä¸Šé¢çš„å®ç°æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ª<strong>åˆ·æ–°æ–¹æ¡ˆ</strong>ï¼šå¦‚æœ <code>strategy</code> æ˜¯ <code>.reloadData</code>ï¼Œé‚£ä¹ˆä¼šç›´æ¥è°ƒç”¨ <code>UICollectionView</code> çš„ <code>reloadData</code> æ–¹æ³•ï¼ˆå³ä¸ä½¿ç”¨ Epoxy å†…ç½®çš„ Diff ç®—æ³•ï¼‰ï¼Œæ­¤æ—¶ <code>collectionView(_: cellForItemAt:)</code> æ–¹æ³•<strong>å¿…æ‰§è¡Œ</strong>ï¼Œæ–°çš„ <code>Content</code> å¯ä»¥è¢«æ­£ç¡®åœ°æ›´æ–°ã€‚</p>
<p>ä¹‹æ‰€ä»¥ä¿ç•™æ³¨é‡Šï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„æ³¨é‡Šæ¯”è¾ƒå…³é”®ã€‚é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼šåˆæ¬¡åŠ è½½æ—¶ï¼Œæˆ–è€…å¯¹ä¸€ä¸ªå°šæœªå…·æœ‰å°ºå¯¸çš„ <code>CollectionView</code> è°ƒç”¨åˆ·æ–°æ—¶ï¼Œå°†<strong>å¿½ç•¥</strong>å¤–éƒ¨å‚æ•°ï¼Œ<strong>æ°¸è¿œä½¿ç”¨</strong> <code>.reloadData</code> æ–¹å¼è¿›è¡Œåˆ·æ–°ã€‚</p>
<p>é‚£å¦‚æœä½¿ç”¨å…¶ä»–çš„ <code>strategy</code> å‘¢ï¼Ÿå°±éœ€è¦å…³æ³¨ <code>performUpdates</code> é—­åŒ…é‡Œè°ƒç”¨çš„ <code>performUpdates(data: animated:)</code> æ–¹æ³•äº†ã€‚</p>
<blockquote>
<p>è¿™é‡Œç¨å¾®æä¸€ä¸‹ <code>UICollectionView</code> çš„ <code>performBatchUpdates(_: completion:)</code> æ–¹æ³•ï¼Œå®ƒæ˜¯ç”¨æ¥å°†å¤šä¸ªæ“ä½œï¼ˆupdateã€insertã€delete ç­‰ï¼‰ï¼Œåˆå¹¶è‡³ä¸€ä¸ªåŠ¨ç”»å†…è¿›è¡Œå±•ç¤ºã€‚<br>
å› ä¸º <code>performUpdates(data: animated:)</code> é‡Œä½¿ç”¨äº† diff ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¼šåŒæ—¶è®¡ç®—å‡ºä¸Šè¿°å¤šç§æ“ä½œï¼Œæ‰€ä»¥ä¸ºäº†æ›´å¥½çš„ UI äº¤äº’å±•ç¤ºï¼Œéœ€è¦å°†è¿™äº›æ“ä½œåˆå¹¶è‡³ä¸€ä¸ªåŠ¨ç”»å†…å±•ç¤ºã€‚</p>
</blockquote>
<p><code>performUpdates(data: animated:)</code> æ–¹æ³•å®ç°æ¯”è¾ƒå¤šï¼Œè¿™é‡ŒæŒ‘ä¸€äº›æˆ‘ä»¬å…³æ³¨çš„è´´ä¸€ä¸‹ï¼š</p>
<pre><code class="language-swift">open class CollectionView: UICollectionView {
  ...

  private func performUpdates(data: CollectionViewData, animated: Bool) {
    let result = epoxyDataSource.applyData(data)
    updateState = .updating(from: result.oldData)

    for (fromIndexPath, toIndexPath) in result.changeset.itemChangeset.updates {
      if
        let cell = cellForItem(at: fromIndexPath) as? CollectionViewCell,
        let item = epoxyDataSource.data?.item(at: toIndexPath)
      {
        let metadata = ItemCellMetadata(
          traitCollection: traitCollection,
          state: cell.state,
          animated: animated)
        item.configure(cell: cell, with: metadata) // â¬…ï¸ ç†Ÿæ‚‰çš„è€æœ‹å‹
        item.configureStateChange(in: cell, with: metadata)
      }
    }

    ...

    deleteSections(result.changeset.sectionChangeset.deletes)
    deleteItems(at: result.changeset.itemChangeset.deletes)

    for (fromIndex, toIndex) in result.changeset.sectionChangeset.moves {
      moveSection(fromIndex, toSection: toIndex)
    }

    for (fromIndexPath, toIndexPath) in result.changeset.itemChangeset.moves {
      moveItem(at: fromIndexPath, to: toIndexPath) // â¬…ï¸ moveItem æœªå¿…ä¼šè§¦å‘ cell åŠ è½½
    }

    insertSections(result.changeset.sectionChangeset.inserts)
    insertItems(at: result.changeset.itemChangeset.inserts) // â¬…ï¸ insertItems ä¹Ÿä¼šè§¦å‘ cell åŠ è½½
  }

  ...
}
</code></pre>
<p>æ–¹æ³•å®ç°çš„ç¬¬ä¸€è¡Œï¼Œ<code>epoxyDataSource.applyData(data)</code> å°±æ˜¯åº”ç”¨ diff ç®—æ³•ã€‚ä¹‹å‰å†™çš„ Epoxy æºç åˆ†æç³»åˆ—æ–‡ç« ä¸­ï¼Œ<a href="/epoxy-source-code-notes-1/">ç¬¬ä¸€ç¯‡</a>å°±æ˜¯æœ‰å…³ Epoxy çš„ Diff ç®—æ³•çš„ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ç®—æ³•åŸç†ã€‚</p>
<p>åœ¨è¿™ä¸ªæ–¹æ³•å®ç°ä¸­å¯ä»¥è¯´æœ‰ä¸¤ä¸ªåˆ·æ–°é€»è¾‘ï¼š</p>
<ul>
<li>ç†Ÿæ‚‰çš„æœ‹å‹ï¼š<code>item.configure(cell: cell, with: metadata)</code>ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸Šé¢çš„æ¡ä»¶éƒ½æ»¡è¶³ï¼Œé‚£ä¹ˆ <code>configure(cell: with:)</code> æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œ<code>Content</code> å°±ä¼šè¢«æ›´æ–°ã€‚</li>
<li>åˆæˆ–è€…å½’åˆ° <code>inserts</code> é‡Œï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„ Cell æ’å…¥åˆ°åˆ—è¡¨ä¸­ã€‚</li>
</ul>
<blockquote>
<p><code>IndexPathChangeset</code> åŒ…å«ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<pre><code class="language-swift">public struct IndexPathChangeset {
  ...

  /// The inserted `IndexPath`s needed to get from the old collection to the new collection.
  public var inserts: [IndexPath]

  /// The deleted `IndexPath`s needed to get from the old collection to the new collection.
  public var deletes: [IndexPath]

  /// The updated `IndexPath`s needed to get from the old collection to the new collection.
  public var updates: [(old: IndexPath, new: IndexPath)]

  /// The moved `IndexPath`s needed to get from the old collection to the new collection.
  public var moves: [(old: IndexPath, new: IndexPath)]

  ...
}
</code></pre>
</blockquote>
<p>è¿™ä¸¤ä¸ªæ–¹æ¡ˆä¸­ï¼Œ<code>inserts</code> çš„é€»è¾‘å¾ˆç®€å•ã€‚è®©æˆ‘ä»¬å¿½ç•¥ diff ç®—æ³•çš„é€»è¾‘ï¼Œç›´æ¥è¯´ç»“è®ºï¼šåªè¦ <code>dataID</code> å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ–°çš„ <code>ItemModel</code>ï¼Œå°±ä¼šæ‰§è¡Œ delete &amp; insertã€‚æ‰€ä»¥ç¬¬äºŒä¸ª<strong>åˆ·æ–°æ–¹æ¡ˆ</strong>å°±æ˜¯ï¼šä¿®æ”¹å‰åï¼Œ<code>ItemModel</code> çš„ <code>dataID</code> ä¸åŒã€‚</p>
<p>é‚£ <code>configure(cell: with:)</code> çš„å‰ç½®æ¡ä»¶éƒ½æœ‰å“ªäº›å‘¢ï¼Ÿé¦–å…ˆæ˜¯ for å¾ªç¯çš„æ•°ç»„ä¸ä¸ºç©ºï¼Œå…¶æ¬¡æ˜¯ä¸¤ä¸ª ifã€‚èªæ˜çš„ä½ åº”è¯¥å¯ä»¥å‘ç°ï¼Œè¿™ä¸¤ä¸ª if ä¸æ˜¯é€»è¾‘é‡ç‚¹ï¼Œç¬¬ä¸€ä¸ª if åªæ˜¯ä¸ºäº†æ»¡è¶³ Swift è¯­æ³•çš„ç±»å‹è½¬æ¢ï¼Œè€Œç¬¬äºŒä¸ª if æ˜¯ä¸ºäº†åˆ¤æ–­ Cell æ˜¯å¦å±•ç¤ºå‡ºæ¥ï¼Œé¿å… <code>configure(cell: with:)</code> å¤šæ¬¡è°ƒç”¨ã€‚æ‰€ä»¥é‡ç‚¹å°±åœ¨äº <code>result.changeset.itemChangeset.updates</code> æ˜¯å¦ä¸ºç©ºã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹å°±æ˜¯ï¼šå¦‚ä½•ä¿®æ”¹æˆ‘ä»¬çš„æ•°æ®æºï¼Œå¯ä»¥è®©å…¶å½’åˆ° <code>updates</code> é›†åˆé‡Œã€‚æ¡ä»¶æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>è¿™ä¸ª <code>ItemModel</code> åœ¨åˆ·æ–°å‰å·²ç»å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œåœ¨åˆ—è¡¨ä¸­å…·æœ‰ Indexã€‚</li>
<li><code>ItemModel</code> çš„ <code>isDiffableItemEqual(to:)</code> æ–¹æ³•è¿”å› <code>false</code>ã€‚</li>
</ul>
<p>ç›¸å…³æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-swift">extension ItemModel: Diffable {
  ...

  public func isDiffableItemEqual(to otherDiffableItem: Diffable) -&gt; Bool {
    guard let other = otherDiffableItem as? Self else {
      return false
    }
    return isErasedContentEqual?(other) ?? true
  }
}
</code></pre>
<p><code>isErasedContentEqual</code> åœ¨ <code>ItemModel</code> åˆå§‹åŒ–æ—¶è¿›è¡Œè®¾ç½®ï¼š</p>
<pre><code class="language-swift">public struct ItemModel&lt;View: UIView&gt;: ViewEpoxyModeled {
  ...

  public init&lt;Content: Equatable&gt;(
    dataID: AnyHashable,
    content: Content,
    setContent: @escaping (CallbackContext, Content) -&gt; Void)
  {
    self.dataID = dataID
    erasedContent = content // â¬…ï¸ erasedContent å°±æ˜¯ content
    self.setContent = { setContent($0, content) }
    isErasedContentEqual = { otherModel in
      guard let otherContent = otherModel.erasedContent as? Content else { return false }
      return otherContent == content // â¬…ï¸ Content éµå¾ª Equatable çš„ç›®çš„å°±åœ¨æ­¤
    }
  }

  ...
}
</code></pre>
<p>ä»ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•å®ç°ä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç»“è®ºï¼š</p>
<ul>
<li>å¦‚æœ <code>EpoxyableView</code> æ²¡æœ‰å®šä¹‰ <code>Content</code>ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸å­˜åœ¨ <code>updates</code> çš„é€»è¾‘ã€‚</li>
<li>æ›´æ–°å‰åï¼Œä¸¤ä¸ª <code>ItemModel</code> çš„ <code>Content</code> ä¸ç›¸ç­‰ï¼Œ<code>EpoxyableView</code> çš„ <code>setContent(_: animated:)</code> æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ã€‚</li>
</ul>
<p>é‚£ä¹ˆç¬¬ä¸‰ç§<strong>åˆ·æ–°æ–¹æ¡ˆ</strong>å°±æ˜¯ï¼šç¡®ä¿ä¿®æ”¹å‰åçš„ <code>Content</code> ä¸ç›¸ç­‰ã€‚</p>
<h4 id="å°ç»“-3">å°ç»“</h4>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ï¼Œåœ¨è°ƒç”¨ <code>setSections(_: strategy:)</code> æ–¹æ³•ä¹‹åï¼Œ<code>Style</code> ä¸å˜çš„å‰æä¸‹ï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µ <code>EpoxyableView</code> çš„ <code>setContent(_: animated)</code> æ–¹æ³•å°†è¢«è°ƒç”¨ï¼š</p>
<ul>
<li><code>strategy</code> ä¸º <code>.reloadData</code> æ—¶ã€‚
<ul>
<li>åŒ…æ‹¬ç©º <code>CollectionView</code> åˆæ¬¡åŠ è½½æ•°æ®ï¼Œæˆ–è€… <code>CollectionView</code> å°šæ²¡æœ‰ Size æ—¶ã€‚</li>
</ul>
</li>
<li>ä¿®æ”¹æ•°æ®å‰åï¼Œ<code>ItemModel</code> çš„ <code>dataID</code> å‘ç”Ÿäº†æ”¹å˜ã€‚</li>
<li>ä¿®æ”¹æ•°æ®å‰åï¼Œ<code>Content</code> çš„ <code>==</code> è¿”å› <code>false</code>ï¼Œå³ä¸¤ä¸ª <code>Content</code> ä¸ç›¸ç­‰ã€‚</li>
</ul>
<p>æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯æœ‰æ•ˆçš„ï¼š</p>
<pre><code class="language-swift">  private var count = 0 {
    didSet { setItems(items, animated: true) }
  }

  @ItemModelBuilder 
  private var items: [ItemModeling] {
    TextRow.itemModel(
      dataID: DataID.row,
      content: .init(
        title: &quot;Count \(count)&quot;,
        body: &quot;Tap to increment&quot;),
      style: .large)
      .didSelect { [weak self] _ in
        self?.count += 1
      }
  }
</code></pre>
<h2 id="æ€»ç»“-ä¸­åœºæ€»ç»“-">æ€»ç»“ <!-- ä¸­åœºæ€»ç»“ --></h2>
<p>åˆ°è¿™é‡Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼Œå€ŸåŠ© Epoxy çš„æœºåˆ¶æˆ‘ä»¬åº”è¯¥å¦‚ä½•åˆ·æ–°åˆ—è¡¨ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">æ–¹æ³•</th>
<th style="text-align:left">æè¿°</th>
<th style="text-align:center">æ¨èæŒ‡æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ä½¿ç”¨ä¸åŒçš„ <code>dataID</code></td>
<td style="text-align:left">æ¯”å¦‚å£°æ˜ä¸€ä¸ª <code>enum DataID { case some(value: String) }</code>ï¼Œæ¯æ¬¡åˆ·æ–°æ—¶ä¿®æ”¹ value çš„å€¼ã€‚<br> æˆ–è€…å°† <code>dataID</code> å’Œæ•°ç»„çš„ä¸‹æ ‡åšå¯¹åº”ï¼Œè¿™æ ·åœ¨ç§»åŠ¨ Cell æ—¶ï¼Œç›¸å½“äºåŒä¸€ä¸ª ItemModel çš„ Content å‘ç”Ÿäº†å˜åŒ–ã€‚</td>
<td style="text-align:center">ğŸŒŸ</td>
</tr>
<tr>
<td style="text-align:left">ä½¿ç”¨ä¸åŒçš„ <code>Style</code></td>
<td style="text-align:left">å°†éœ€è¦å˜åŒ–çš„å€¼å®šä¹‰åœ¨ <code>Style</code> é‡Œï¼Œåˆ·æ–° <code>Style</code> ååˆ·æ–°åˆ—è¡¨</td>
<td style="text-align:center">ğŸŒŸğŸŒŸ</td>
</tr>
<tr>
<td style="text-align:left">åˆ©ç”¨ <code>Equatable</code>ï¼Œä¿®æ”¹ <code>Content</code></td>
<td style="text-align:left">ç¡®ä¿ <code>Content</code> çš„åˆ¤ç­‰é€»è¾‘ç¬¦åˆæ‚¨çš„è¦æ±‚ï¼Œä¿®æ”¹ <code>Content</code> ååˆ·æ–°åˆ—è¡¨</td>
<td style="text-align:center">ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</td>
</tr>
</tbody>
</table>
<blockquote>
<p>æœ‰ä¸€ä¸ªåˆ·æ–°ä¹‹å¤–çš„å¼•ç”³è¯é¢˜ï¼Œä¸Šæ–‡ä¹Ÿæåˆ°è¿‡ï¼Œé‚£å°±æ˜¯ä»€ä¹ˆæ ·çš„æ•°æ®è¯¥æ”¾åˆ° <code>Style</code> ä¸­ã€‚å¸Œæœ›çœ‹å®Œè¿™ç¯‡æ–‡ç« åï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ä½ ä¹Ÿèƒ½æœ‰æ–°çš„æ€è€ƒå’Œç†è§£ã€‚</p>
</blockquote>
<p>æƒ³å¿…å¯¹äºèªæ˜çš„ä½ æ¥è¯´ï¼Œä¸Šè¿°åˆ†æè¿‡ç¨‹æœ‰ç‚¹å¤ªç®€å•äº†ï¼Œåªè¦ç¨å¾®æ·±å…¥è¿½ä¸€ä¸‹ä»£ç ï¼Œå°±èƒ½æ¢³ç†æ¸…æ¥šè¿™äº›æƒ…å†µã€‚ç”šè‡³ Epoxy çš„ demo å’Œ<a href="https://github.com/airbnb/epoxy-ios/wiki/EpoxyCollectionView">æ–‡æ¡£</a>ä¸­å·²ç»ä»‹ç»çš„å¾ˆæ¸…æ¥šäº†ã€‚</p>
<p>ä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œç”Ÿæ´»å°±æ˜¯è¿™ä¹ˆè¯¡å¼‚ã€‚ä¸æŠŠè¿™äº›è¿‡ç¨‹å†™ä¸‹æ¥çš„è¯ï¼Œå¯¹äºä½¿ç”¨è¿˜ä¸ç†Ÿç»ƒçš„æˆ‘è€Œè¯´ï¼Œç»å¸¸ä¼šé™·å…¥æ–‡ç« å¼€å¤´çš„ç–‘é—®ï¼šâ€œä¸ºä»€ä¹ˆåˆ—è¡¨åˆ·æ–°åæ•°æ®æ²¡å˜â€ å’Œ â€œä¸ºä»€ä¹ˆå®ƒåˆ·æ–°åæ•°æ®å°±å˜äº†â€ã€‚ä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬çŸ¥é“äº† â€œå½“ <code>Content</code> ä¸ä¸€è‡´æ—¶åˆ·æ–°åˆ—è¡¨ï¼Œåˆ—è¡¨æ•°æ®ä¼šå‘ç”Ÿå˜åŒ–â€ å¹¶æŒ‰ä¹‹ä»˜å‡ºå®è·µæ—¶ï¼Œä¾ç„¶ä¼šæœ‰ä¸ç”Ÿæ•ˆçš„æƒ…å†µå‘ç”Ÿã€‚</p>
<p>è¿™ç¯‡æ–‡ç« è¿˜ä¸æ˜¯å®Œå…¨ä½“ï¼Œæ—¥åå½“æˆ‘å†æ¬¡å‘ç°åˆ·æ–°å¤±æ•ˆçš„æƒ…å†µæ—¶ï¼Œæˆ‘å°†å®Œå–„è¿™ç¯‡æ–‡ç« ï¼Œè¡¥å……å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://blog.rakuyo.dev/thread-safety-with-lazy/" class="post-title gt-a-link">
                    Lazy var çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
                </a>
            </div>
        

        

        
            
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
<script>
    // md5.min.js
    !function(n){
        "use strict";
        function d(n,t){var r=(65535&n)+(65535&t);return(n>>16)+(t>>16)+(r>>16)<<16|65535&r}
        function f(n,t,r,e,o,u){return d((c=d(d(t,n),d(e,u)))<<(f=o)|c>>>32-f,r);var c,f}
        function l(n,t,r,e,o,u,c){return f(t&r|~t&e,n,t,o,u,c)}
        function v(n,t,r,e,o,u,c){return f(t&e|r&~e,n,t,o,u,c)}
        function g(n,t,r,e,o,u,c){return f(t^r^e,n,t,o,u,c)}
        function m(n,t,r,e,o,u,c){return f(r^(t|~e),n,t,o,u,c)}
        function i(n,t){var r,e,o,u,c;n[t>>5]|=128<<t%32,n[14+(t+64>>>9<<4)]=t;var f=1732584193,i=-271733879,a=-1732584194,h=271733878;for(r=0;r<n.length;r+=16)f=l(e=f,o=i,u=a,c=h,n[r],7,-680876936),h=l(h,f,i,a,n[r+1],12,-389564586),a=l(a,h,f,i,n[r+2],17,606105819),i=l(i,a,h,f,n[r+3],22,-1044525330),f=l(f,i,a,h,n[r+4],7,-176418897),h=l(h,f,i,a,n[r+5],12,1200080426),a=l(a,h,f,i,n[r+6],17,-1473231341),i=l(i,a,h,f,n[r+7],22,-45705983),f=l(f,i,a,h,n[r+8],7,1770035416),h=l(h,f,i,a,n[r+9],12,-1958414417),a=l(a,h,f,i,n[r+10],17,-42063),i=l(i,a,h,f,n[r+11],22,-1990404162),f=l(f,i,a,h,n[r+12],7,1804603682),h=l(h,f,i,a,n[r+13],12,-40341101),a=l(a,h,f,i,n[r+14],17,-1502002290),f=v(f,i=l(i,a,h,f,n[r+15],22,1236535329),a,h,n[r+1],5,-165796510),h=v(h,f,i,a,n[r+6],9,-1069501632),a=v(a,h,f,i,n[r+11],14,643717713),i=v(i,a,h,f,n[r],20,-373897302),f=v(f,i,a,h,n[r+5],5,-701558691),h=v(h,f,i,a,n[r+10],9,38016083),a=v(a,h,f,i,n[r+15],14,-660478335),i=v(i,a,h,f,n[r+4],20,-405537848),f=v(f,i,a,h,n[r+9],5,568446438),h=v(h,f,i,a,n[r+14],9,-1019803690),a=v(a,h,f,i,n[r+3],14,-187363961),i=v(i,a,h,f,n[r+8],20,1163531501),f=v(f,i,a,h,n[r+13],5,-1444681467),h=v(h,f,i,a,n[r+2],9,-51403784),a=v(a,h,f,i,n[r+7],14,1735328473),f=g(f,i=v(i,a,h,f,n[r+12],20,-1926607734),a,h,n[r+5],4,-378558),h=g(h,f,i,a,n[r+8],11,-2022574463),a=g(a,h,f,i,n[r+11],16,1839030562),i=g(i,a,h,f,n[r+14],23,-35309556),f=g(f,i,a,h,n[r+1],4,-1530992060),h=g(h,f,i,a,n[r+4],11,1272893353),a=g(a,h,f,i,n[r+7],16,-155497632),i=g(i,a,h,f,n[r+10],23,-1094730640),f=g(f,i,a,h,n[r+13],4,681279174),h=g(h,f,i,a,n[r],11,-358537222),a=g(a,h,f,i,n[r+3],16,-722521979),i=g(i,a,h,f,n[r+6],23,76029189),f=g(f,i,a,h,n[r+9],4,-640364487),h=g(h,f,i,a,n[r+12],11,-421815835),a=g(a,h,f,i,n[r+15],16,530742520),f=m(f,i=g(i,a,h,f,n[r+2],23,-995338651),a,h,n[r],6,-198630844),h=m(h,f,i,a,n[r+7],10,1126891415),a=m(a,h,f,i,n[r+14],15,-1416354905),i=m(i,a,h,f,n[r+5],21,-57434055),f=m(f,i,a,h,n[r+12],6,1700485571),h=m(h,f,i,a,n[r+3],10,-1894986606),a=m(a,h,f,i,n[r+10],15,-1051523),i=m(i,a,h,f,n[r+1],21,-2054922799),f=m(f,i,a,h,n[r+8],6,1873313359),h=m(h,f,i,a,n[r+15],10,-30611744),a=m(a,h,f,i,n[r+6],15,-1560198380),i=m(i,a,h,f,n[r+13],21,1309151649),f=m(f,i,a,h,n[r+4],6,-145523070),h=m(h,f,i,a,n[r+11],10,-1120210379),a=m(a,h,f,i,n[r+2],15,718787259),i=m(i,a,h,f,n[r+9],21,-343485551),f=d(f,e),i=d(i,o),a=d(a,u),h=d(h,c);return[f,i,a,h]}
        function a(n){var t,r="",e=32*n.length;for(t=0;t<e;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}
        function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t<e;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}
        function e(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}
        function r(n){return unescape(encodeURIComponent(n))}
        function o(n){return a(i(h(t=r(n)),8*t.length));var t}
        function u(n,t){return function(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,16<o.length&&(o=i(o,8*n.length)),r=0;r<16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}(r(n),r(t))}
        function t(n,t,r){return t?r?u(t,n):e(u(t,n)):r?o(n):e(o(n))}
        "function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:n.md5=t;
    }(this);
</script>


<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '30875151c07a20ceb163',
    clientSecret: '9a57fd47038f45827326ab5b0ab8c796f184a46f',
    repo: 'rakuyomo.github.io',
    owner: 'rakuyoMo',
    admin: ['rakuyoMo'],
    id: md5(location.pathname),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false       // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

            

            
        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/rakuyoMo" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        æ— å¸¸ä¸ºå¸¸ï¼Œå˜åŒ–å³æ°¸æ’
    </div>
    <div>
        Theme <a href="https://github.com/rakuyoMo/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://blog.rakuyo.dev/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
